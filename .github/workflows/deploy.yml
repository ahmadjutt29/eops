name: React CI/CD (Staging & Production)

on:
  push:
    branches:
      - deploy   # Staging
      - main     # Production

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
      # 1. Checkout code
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Install Node.js dependencies
      - name: Install dependencies
        run: npm ci

      # 3. Build React app
      - name: Build React app
        run: npm run build

      # 4. Deploy to server
      - name: Deploy to Server
        shell: pwsh
        run: |
          $distPath = Join-Path $env:GITHUB_WORKSPACE 'dist'
          Write-Host "Dist folder path: $distPath"
          if (-not (Test-Path $distPath)) {
            Write-Host "ERROR: Dist folder does not exist!"
            exit 1
          }
          $distContents = Get-ChildItem $distPath
          Write-Host "Dist folder contents:"
          $distContents | ForEach-Object { Write-Host $_.FullName }

          $branch = "${{ github.ref }}"
          Write-Host "Branch: $branch"

          if ($branch -eq 'refs/heads/deploy') {
            Write-Host "Deploying to STAGING environment..."
            Remove-Item -Recurse -Force 'C:/nginx/html/react_staging/*' -ErrorAction SilentlyContinue
            Copy-Item -Path (Join-Path $distPath '*') -Destination 'C:/nginx/html/react_staging/' -Recurse -Force
            Write-Host "Staging deployment completed."
          } elseif ($branch -eq 'refs/heads/main') {
            Write-Host "Deploying to PRODUCTION environment..."

            # Step 4a: Backup previous production
            Remove-Item -Recurse -Force 'C:/nginx/html/backup_prod/*' -ErrorAction SilentlyContinue
            Copy-Item -Path 'C:/nginx/html/react_prod/*' -Destination 'C:/nginx/html/backup_prod/' -Recurse -Force
            Write-Host "Backup of previous production completed."

            # Step 4b: Deploy new build
            Remove-Item -Recurse -Force 'C:/nginx/html/react_prod/*' -ErrorAction SilentlyContinue
            Copy-Item -Path (Join-Path $distPath '*') -Destination 'C:/nginx/html/react_prod/' -Recurse -Force
            Write-Host "Production deployment completed."

            # Step 4c: Health check
            try {
              $resp = Invoke-WebRequest http://localhost/ -UseBasicParsing
              if ($resp.StatusCode -eq 200) {
                Write-Host "Production is live and healthy."
              } else {
                throw "Health check failed"
              }
            } catch {
              Write-Host "Health check failed! Rolling back..."
              Remove-Item -Recurse -Force 'C:/nginx/html/react_prod/*' -ErrorAction SilentlyContinue
              Copy-Item -Path 'C:/nginx/html/backup_prod/*' -Destination 'C:/nginx/html/react_prod/' -Recurse -Force
              Write-Host "Rollback completed."
              exit 1
            }
          } else {
            Write-Host "Branch is not deploy or main. Skipping deployment."
          }
