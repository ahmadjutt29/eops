name: React CI/CD (Staging & Production)

on:
  push:
    branches:
      - develop
      - main

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
      # =========================================================
      # 1. CHECKOUT
      # =========================================================
      - name: Checkout code
        uses: actions/checkout@v3

      # =========================================================
      # 2. INSTALL DEPENDENCIES
      # =========================================================
      - name: Install dependencies
        run: |
          echo "========== INSTALLING DEPENDENCIES =========="
          npm ci
          echo "========== DEPENDENCIES INSTALLED =========="

      # =========================================================
      # 3. BUILD APPLICATION (conditional)
      # =========================================================
      - name: Build React app
        shell: powershell
        run: |
          echo "========== BUILD STARTED =========="
          echo "Branch detected: ${{ github.ref }}"

          if ("${{ github.ref }}" -eq "refs/heads/develop") {
            echo "Environment: STAGING"
            echo "Running: npm run build -- --mode staging"
            npm run build -- --mode staging
          }
          elseif ("${{ github.ref }}" -eq "refs/heads/main") {
            echo "Environment: PRODUCTION"
            echo "Running: npm run build"
            npm run build
          }
          else {
            echo "UNKNOWN BRANCH – EXITING"
            exit 1
          }

          echo "========== BUILD COMPLETED =========="

      # =========================================================
      # 4. DEPLOY
      # =========================================================
      - name: Deploy to Server
        shell: powershell
        run: |
          echo "========== DEPLOYMENT STARTED =========="

          $distPath = Join-Path $env:GITHUB_WORKSPACE 'dist'

          echo "Build Output Path: $distPath"

          if (-not (Test-Path $distPath)) {
            echo "ERROR: dist folder NOT FOUND"
            exit 1
          }

          echo "========== DIST CONTENT =========="
          Get-ChildItem -Recurse $distPath

          $branch = "${{ github.ref }}"
          echo "Current branch: $branch"

          if ($branch -eq "refs/heads/develop") {

            echo "========== STAGING DEPLOYMENT =========="
            echo "Target: C:/nginx/html/react_staging/"

            Remove-Item -Recurse -Force 'C:/nginx/html/react_staging/*' -ErrorAction SilentlyContinue
            Copy-Item -Path (Join-Path $distPath '*') `
              -Destination 'C:/nginx/html/react_staging/' `
              -Recurse -Force

            echo "Staging deployment COMPLETE"
          }

          elseif ($branch -eq "refs/heads/main") {

            echo "========== PRODUCTION DEPLOYMENT =========="

            echo "Step 1: BACKUP old production"
            Remove-Item -Recurse -Force 'C:/nginx/html/backup_prod/*' -ErrorAction SilentlyContinue
            Copy-Item -Path 'C:/nginx/html/react_prod/*' `
              -Destination 'C:/nginx/html/backup_prod/' `
              -Recurse -Force
            echo "Backup complete"

            echo "Step 2: DEPLOY new production build"
            Remove-Item -Recurse -Force 'C:/nginx/html/react_prod/*' -ErrorAction SilentlyContinue
            Copy-Item -Path (Join-Path $distPath '*') `
              -Destination 'C:/nginx/html/react_prod/' `
              -Recurse -Force
            echo "Production updated"

            echo "Step 3: HEALTH CHECK"
            try {
              $resp = Invoke-WebRequest http://localhost/ -UseBasicParsing
              echo "Health Check Status: $($resp.StatusCode)"

              if ($resp.StatusCode -eq 200) {
                echo "APPLICATION HEALTHY"
              }
              else {
                throw "Returned non-200"
              }
            }
            catch {
              echo "HEALTH CHECK FAILED — ROLLING BACK"

              Remove-Item -Recurse -Force 'C:/nginx/html/react_prod/*' -ErrorAction SilentlyContinue
              Copy-Item -Path 'C:/nginx/html/backup_prod/*' `
                -Destination 'C:/nginx/html/react_prod/' `
                -Recurse -Force

              echo "ROLLBACK COMPLETE"
              exit 1
            }

            echo "Production deployment COMPLETE"
          }

          else {
            echo "Branch is NOT develop or main — SKIPPING DEPLOY"
          }

          echo "========== DEPLOYMENT FINISHED =========="
